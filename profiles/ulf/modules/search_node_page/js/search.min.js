/**
 * @name Search node Angular library
 * @version v1.2.1
 * @link https://github.com/search-node/searchpt
 */
angular.module("searchBoxApp",["communicationService","searchAppConfig","angular-cache"]),angular.module("searchResultApp",["communicationService","searchAppConfig","ngSanitize"]),angular.element(document).ready(function(){"use strict";var e=document.getElementById("searchResultApp");e?angular.bootstrap(e,["searchResultApp"]):console.error('Unable to bootstrap searchResultApp. Missing HTML tag with id "searchResultApp"');var r=document.getElementById("searchBoxApp");r?angular.bootstrap(r,["searchBoxApp"]):console.error('Unable to bootstrap searchBoxApp. Missing HTML tag with id "searchBoxApp"')}),angular.module("searchBoxApp").controller("boxController",["CONFIG","communicatorService","searchProxyService","$scope",function(e,r,t,o){"use strict";function a(){r.$emit("searching",{}),t.search(o.query).then(function(e){t.getFilters().then(function(e){o.filters=e},function(e){console.error(e)}),r.$emit("hits",{hits:e})},function(e){console.error(e)})}function n(){var r=t.getState();o.filters=r.filters,o.template=e.templates.box,o.query={text:"",filters:{}},e.provider.hasOwnProperty("intervals")&&(o.intervals=e.provider.intervals,o.query.intervals={}),e.provider.hasOwnProperty("dates")&&(o.dates=e.provider.dates,o.query.dates={}),r.hasOwnProperty("query")?(o.query=r.query,a()):(e.provider.hasOwnProperty("pager")&&(o.query.pager=angular.copy(e.provider.pager)),e.hasOwnProperty("initialQueryText")?(o.query.text=angular.copy(e.initialQueryText),a()):t.getFilters().then(function(e){o.filters=e},function(e){console.error(e)}))}function s(e){o.query.pager={size:e.size,page:e.page},a()}r.$on("pager",function(e,r){var t=this.$root.$$phase;"$apply"===t||"$digest"===t?s(r):o.$apply(function(){s(r)})}),o.searchClicked=function(){o.query.hasOwnProperty("pager")&&(o.query.pager=angular.copy(e.provider.pager)),a()},n()}]),angular.module("searchResultApp").controller("resultController",["CONFIG","communicatorService","$scope",function(e,r,t){"use strict";t.template=e.templates.result,t.searching=!1,e.provider.hasOwnProperty("pager")&&(t.pager=angular.copy(e.provider.pager)),t.search=function(){r.$emit("pager",t.pager)},t.hits=[],r.$on("hits",function(e,r){var o=this.$root.$$phase;"$apply"===o||"$digest"===o?(t.hits=r.hits,t.searching=!1):t.$apply(function(){t.hits=r.hits,t.searching=!1})}),r.$on("searching",function(e,r){var o=this.$root.$$phase;"$apply"===o||"$digest"===o?t.searching=!0:t.$apply(function(){t.searching=!0})}),r.$on("pager",function(e,r){var o=this.$root.$$phase;"$apply"===o||"$digest"===o?t.pager=r:t.$apply(function(){t.pager=r})})}]),angular.module("searchBoxApp").directive("keyCode",function(){"use strict";return{restrict:"A",link:function(e,r,t){r.bind("keypress",function(r){var o=r.which||r.keyCode;o===Number(t.code)&&e.$apply(function(){e.$eval(t.keyCode,{$event:r})})})}}}),angular.module("searchResultApp").directive("searchPager",["CONFIG",function(e){"use strict";return{restrict:"E",replace:!0,scope:!0,controller:["$scope",function(e){e.changePage=function(r){e.pager.page=r,e.search()},e.prevPage=function(){e.pager.page>0&&(e.pager.page--,e.search())},e.nextPage=function(){e.pager.page<e.pager.max-1&&(e.pager.page++,e.search())},e.$watch("hits",function(r){var t=[];if(e.pager.max=0,r.hits>e.pager.size){e.pager.max=Math.ceil(r.hits/e.pager.size);for(var o=0;o<e.pager.max;o++)t.push(o)}e.pager.pages=t})}],templateUrl:e.templates.pager}}]),angular.module("searchBoxApp").service("jsonProvider",["CONFIG","$q","$http",function(e,r,t){"use strict";var o=[];t.get(e.provider.data).then(function(e){o=e.data}),this.getFilters=function(){return{tags:{name:"Tags",type:"and",items:[{name:"Angular",value:"angular"},{name:"Developer",value:"developer"},{name:"Javascript",value:"javascript"},{name:"Chrome",value:"chrome"}]},levels:{name:"Levels (or)",type:"or",items:[{name:"First",value:1},{name:"Second",value:2},{name:"Third",value:3},{name:"Fourth",value:4}]}}},this.search=function(e){var t=this,a=angular.copy(o),n=r.defer();return""!==e.text&&(a=JSON.search(o,'//*[contains(title, "'+e.text+'")]')),angular.forEach(e.filters,function(e,r){var o=t.getFilters(),n=!1;angular.forEach(e,function(e,t){e&&("or"===o?n===!1?n="//*["+r+'="'+t+'"]':n+="|//*["+r+'="'+t+'"]':a=JSON.search(a,"//*["+r+'="'+t+'"]'))}),"or"===o&&n&&(a=JSON.search(a,n))}),n.resolve({hits:a.length,results:a}),n.promise}}]),angular.module("searchBoxApp").service("searchNodeProvider",["CONFIG","$q","$http","CacheFactory",function(e,r,t,o){"use strict";function a(e){var r=0;for(var t in e)e.hasOwnProperty(t)&&r++;return r}function n(){var e=r.defer();if(h)e.resolve();else{var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){("loaded"===t.readyState||"complete"===t.readyState)&&(t.onreadystatechange=null,h=!0,e.resolve())}:t.onload=function(){h=!0,e.resolve()},t.src=f.host+"/socket.io/socket.io.js",document.getElementsByTagName("head")[0].appendChild(t)}return e.promise}function s(e){n().then(function(){u=io.connect(f.host,{query:"token="+v,"force new connection":!0,"max reconnection attempts":1/0}),u.on("error",function(r){console.error(r,"Search socket error."),e.reject(r)}),u.on("connect",function(){e.resolve("Connected to the server.")}),u.on("disconnect",function(e){})})}function i(){var e=r.defer();return void 0===u?null!==v?s(e):t.get(f.auth).success(function(r){v=r.token,s(e)}).error(function(r,t){console.error(r,"Authentication (search) to search node failed ("+t+")"),e.reject(t)}):e.resolve("Connected to the server."),e.promise}function l(e){var r={aggs:{}};for(var t in e)switch(t){case"taxonomy":for(var o=e[t],a=0;a<o.length;a++){var n=o[a];r.aggs[n.field]={terms:{field:n.field+".raw",size:0}}}break;case"boolean":for(var s=e[t],a=0;a<s.length;a++){var n=s[a];r.aggs[n.field]={terms:{field:n.field,size:0}}}break;default:console.error("Aggregation filter has unknown type - "+t)}return r}function c(r){var t={taxonomy:{},"boolean":{}};if(e.provider.hasOwnProperty("filters")){var o=e.provider.filters;for(var n in o)for(var s=o[n],i=0;i<s.length;i++){var l=angular.copy(s[i]);if(t[n][l.field]={name:l.name},0!==a(r))switch(n){case"taxonomy":t[n][l.field].items=l.terms;for(var c=0;c<r[l.field].buckets.length;c++){var p=r[l.field].buckets[c];t[n][l.field].items.hasOwnProperty(p.key)?t[n][l.field].items[p.key].count=Number(p.doc_count):console.error("Filter value don't match configuration: "+l.field+" -> "+p.key)}break;case"boolean":for(var c=0;c<r[l.field].buckets.length;c++){var p=r[l.field].buckets[c];t[n][l.field].count=0,"T"===p.key&&p.doc_count>0&&(t[n][l.field].count=Number(p.doc_count))}break;default:console.error("Unknown filter type used in parseFilters: "+n)}}}return t}function p(){var r={};if(e.provider.hasOwnProperty("filters")){var t=e.provider.filters;if(t.hasOwnProperty("boolean"))for(var o=0;o<t["boolean"].length;o++){var a=t["boolean"][o];r[a.field]={name:a.name}}}return r}var u,f=e.provider,h=!1,v=null,d=new o("searchCache"+e.id,{maxAge:1e3*f.cacheExpire,deleteOnExpire:"aggressive",storageMode:"localStorage"}),g={taxonomy:void 0,"boolean":void 0};this.getRawFilters=function(){var r={};if(e.provider.hasOwnProperty("filters")){var t=e.provider.filters;if(t.hasOwnProperty("taxonomy")){r.taxonomy={};for(var o=0;o<t.taxonomy.length;o++){var a=t.taxonomy[o];r.taxonomy[a.field]={name:a.name,items:a.terms}}}r["boolean"]=p()}return r},this.getFilters=function(){var t=r.defer();if(e.provider.hasOwnProperty("filters"))if(void 0===g.taxonomy){var o=d.get("filters");if(void 0!==o)g=o,t.resolve(angular.copy(g));else{var a=l(e.provider.filters);i().then(function(){u.emit("count",a),u.once("counts",function(e){g=c(e),d.put("filters",g),t.resolve(g)}),u.once("searchError",function(e){console.error("Search error",e.message),t.reject(e.message)})})}}else t.resolve(angular.copy(g));else t.resolve({});return t.promise},this.search=function(t){var o=r.defer(),n={index:f.index,query:{filtered:{query:{match_all:{}}}}};if(void 0!==t.text&&""!==t.text){var s=f.fields;if(f.hasOwnProperty("boost")&&a(f.boost))for(var p in s)f.boost.hasOwnProperty(s[p])&&(s[p]=s[p]+"^"+f.boost[s[p]]);n.query.filtered.query={multi_match:{query:t.text,fields:s,analyzer:"string_search"}}}if(t.hasOwnProperty("sort")&&a(t.sort)>0){n.sort={};for(var h in t.sort)n.sort[h]={order:t.sort[h]}}if(t.hasOwnProperty("filters")){var v=angular.copy(t.filters),m={bool:{must:[]}};if(v.hasOwnProperty("taxonomy"))for(var h in v.taxonomy){var y=v.taxonomy[h],w={execution:"and"};w[h+".raw"]=[];for(var b in y)y[b]&&w[h+".raw"].push(b);w[h+".raw"].length&&m.bool.must.push({terms:w})}if(v.hasOwnProperty("boolean"))for(var h in v["boolean"])if(v["boolean"][h]){var b={};b[h]=v["boolean"][h],m.bool.must.push({term:b})}m.bool.must.length&&(n.query.filtered.filter=m)}if(t.hasOwnProperty("pager")&&(n.size=t.pager.size,n.from=t.pager.page*t.pager.size),e.provider.hasOwnProperty("filters")){var x=l(e.provider.filters);angular.extend(n,x)}if(t.hasOwnProperty("intervals")){n.query.filtered.hasOwnProperty("filter")||(n.query.filtered.filter={bool:{must:[]}});for(var h in t.intervals){var O={range:{}};O.range[h]={gte:t.intervals[h].from,lte:t.intervals[h].to},n.query.filtered.filter.bool.must.push(O)}}if(t.hasOwnProperty("dates")){n.query.filtered.hasOwnProperty("filter")?n.query.filtered.filter.bool.should=[]:n.query.filtered.filter={bool:{should:[]}};for(var h in t.dates){var P=f.dates[h],$={bool:{must:[{range:{}},{range:{}}]}};$.bool.must[0].range[P.from]={lte:t.dates[h].from},$.bool.must[1].range[P.to]={gt:t.dates[h].from},n.query.filtered.filter.bool.should.push(angular.copy($)),$.bool.must[0].range[P.from]={lt:t.dates[h].to},$.bool.must[1].range[P.to]={gte:t.dates[h].to},n.query.filtered.filter.bool.should.push(angular.copy($)),$.bool.must[0].range[P.from]={gte:t.dates[h].from},$.bool.must[1].range[P.to]={lte:t.dates[h].to},n.query.filtered.filter.bool.should.push(angular.copy($))}}var k=CryptoJS.MD5(JSON.stringify(n)).toString(),q=d.get(k);return void 0!==q?(q.hasOwnProperty("aggs")&&(g=c(angular.copy(q.aggs))),o.resolve(q)):i().then(function(){u.emit("search",n),u.once("result",function(e){e.hasOwnProperty("aggs")&&(g=c(angular.copy(e.aggs))),d.put(k,e),o.resolve(e)}),u.once("searchError",function(e){console.error("Search error",e.message),o.reject(e.message)})}),o.promise}}]),angular.module("communicationService",[]).service("communicatorService",["$rootScope","$window",function(e,r){"use strict";r.rootScopes=r.rootScopes||[],r.rootScopes.push(e),this.$emit=function(e,t){angular.forEach(r.rootScopes,function(r){r.$emit(e,t)})},this.$on=function(r,t){e.$on(r,function(r,o){t.apply(e,[r,o])})}}]),angular.module("searchBoxApp").service("searchProxyService",["CONFIG","communicatorService","$injector",function(e,r,t){"use strict";function o(e){var r=0;for(var t in e)e.hasOwnProperty(t)&&r++;return r}function a(e){var r=[];if(e.hasOwnProperty("text")&&0!==e.text.length&&r.push("text="+encodeURIComponent(e.text)),e.hasOwnProperty("filters"))for(var t in e.filters)if(0!==o(e.filters[t])){var a=e.filters[t],n=[];for(var s in a){var i=[];if("boolean"==typeof a[s]&&a[s]===!0)n.push(s);else{for(var l in a[s])a[s][l]===!0&&i.push(l);i.length&&n.push(s+":"+i.join(";"))}}n.length&&r.push("filters["+t+"]="+encodeURIComponent(n.join("?")))}if(e.hasOwnProperty("intervals")&&0!==o(e.intervals)){var c=[];for(var s in e.intervals){var p=e.intervals[s];c.push(s+";"+p.from+";"+p.to)}r.push("intervals="+encodeURIComponent(c.join("?")))}if(e.hasOwnProperty("dates")&&0!==o(e.dates)){var u=[];for(var s in e.dates){var f=e.dates[s];u.push(s+";"+f.from+";"+f.to)}r.push("dates="+encodeURIComponent(u.join("?")))}return e.hasOwnProperty("pager")&&r.push("pager="+e.pager.page+":"+e.pager.size),r.join("&")}function n(e){var r={},t=e.substr(2).split("&");for(var o in t){var a=t[o].split("="),n=decodeURIComponent(a[0]);switch(-1!==n.indexOf("[")&&(n=n.substr(0,n.indexOf("["))),n){case"text":r.text=decodeURIComponent(a[1]);break;case"filters":var s=decodeURIComponent(a[0]),i=s.substr(s.indexOf("[")+1).slice(0,-1),l=decodeURIComponent(a[1]).split("?");if(l.length){r.hasOwnProperty("filters")||(r.filters={taxonomy:{},"boolean":{}});for(var c in l)switch(i){case"taxonomy":var p=l[c].split(":");r.filters[i][p[0]]=p[1].split(";").reduce(function(e,r,t){return e[r]=!0,e},{});break;case"boolean":r.filters[i][l[c]]=!0;break;default:console.error("Decoding of search hash has unknown filter type - "+i)}}break;case"intervals":var u=decodeURIComponent(a[1]).split("?");if(u.length){r.intervals={};for(var c in u){var f=u[c].split(";");r.intervals[f[0]]={from:f[1],to:f[2]}}}break;case"dates":var h=decodeURIComponent(a[1]).split("?");if(h.length){r.dates={};for(var c in h){var v=h[c].split(";");r.dates[v[0]]={from:v[1],to:v[2]}}}break;case"pager":var d=a[1].split(":");r.pager={page:Number(d[0]),size:Number(d[1])};break;default:console.error("Decoding of search hash has unknown parts - "+a[0])}}return r}var s=t.get(e.provider.service);this.getState=function(){var e={filters:this.getRawFilters()},r=window.location.hash;return r.length>2&&(e.query=n(r)),e},this.search=function(r){var t=angular.copy(r);if(e.provider.hasOwnProperty("intervals")&&e.provider.intervals.length){if(t.hasOwnProperty("intervals"))for(var o in t.intervals)t.intervals[o].hasOwnProperty("from")&&""!==t.intervals[o].from||t.intervals[o].hasOwnProperty("to")&&""!==t.intervals[o].to||delete t.intervals[o]}else t.hasOwnProperty("intervals")&&delete t.intervals;if(window.location.hash=a(t),e.provider.hasOwnProperty("force")&&e.provider.force.length){t.hasOwnProperty("filters")||(t.filters={});var n=e.provider.force;for(var i in n){var l=n[i];t.filters.hasOwnProperty(l.type)||(t.filters[l.type]={}),t.filters.hasOwnProperty(l.field)||(t.filters[l.type][l.field]={});for(var c in l.values)t.filters[l.type][l.field][l.values[c]]=!0}}return s.search(t)},this.getRawFilters=function(){return s.getRawFilters()},this.getFilters=function(){return s.getFilters()}}]);
//# sourceMappingURL=maps/search.js.map
