<?php
/**
 * @file
 * Code for the Ulf maps feature.
 */

include_once 'ulf_maps.features.inc';

/**
 * Implements hook_form_alter().
 */
function ulf_maps_form_alter(&$form, &$form_state, $form_id) {
  // The form ids of the forms to alter.
  $form_ids = array(
    'user_profile_form',
    'course_node_form',
    'course_educators_node_form',
  );

  if (in_array($form_id, $form_ids)) {
    // If location modules are set up.
    if (isset($form['locations'])) {
      // Attach js to the form.
      $form['#attached']['js'][] = drupal_get_path('module', 'ulf_maps') . '/js/show-map.admin.js';

      // Add change location button.
      $form['locations'][0]['reset'] = array(
        '#weight' => '-94',
        '#type' => 'submit',
        '#value' => t('Change address'),
        '#attributes' => array(
          'class' => array('js-change-address'),
        ),
        '#ajax' => array(
          'callback' => 'ulf_maps_reset_coordinates',
          'wrapper' => 'location-wrapper',
          'method' => 'replace',
          'effect' => 'fade',
        ),
      );

      // Add specify on the map button, which change the map location pointer
      // based on the entered address.
      $form['locations'][0]['#prefix'] = '<div id="location-wrapper">';
      $form['locations'][0]['#suffix'] = '</div>';
      $form['locations'][0]['submit'] = array(
        '#weight' => '-95',
        '#type' => 'submit',
        '#value' => t('Specify entrance on map'),
        '#attributes' => array(
          'class' => array('js-specify-on-map'),
        ),
        '#ajax' => array(
          'callback' => 'ulf_maps_update_location',
          'wrapper' => 'location-wrapper',
          'method' => 'replace',
          'effect' => 'fade',
        ),
      );
    }
  }
}

/**
 * Ajax callback that updates the map marker.
 */
function ulf_maps_update_location($form, &$form_state) {
  // Get lat/lon for the address.
  $data = location_latlon_exact($form_state['values']['locations'][0]);

  // Update the values in the form.
  $form['locations'][0]['locpick']['user_latitude']['#value'] = $data['lat'];
  $form['locations'][0]['locpick']['user_longitude']['#value'] = $data['lon'];

  // Update default values with the new values.
  $form['locations'][0]['#default_value']['latitude'] = $data['lat'];
  $form['locations'][0]['#default_value']['longitude'] = $data['lon'];
  $form_state['values']['locations'][0]['locpick']['user_latitude'] = $data['lat'];
  $form_state['values']['locations'][0]['locpick']['user_longitude'] = $data['lon'];

  // Update map information with new location.
  $form['locations'][0]['locpick']['map']['#gmap_settings']['latitude'] = $data['lat'];
  $form['locations'][0]['locpick']['map']['#gmap_settings']['longitude'] = $data['lon'];
  $form['locations'][0]['locpick']['map']['#gmap_settings']['latlong'] = $data['lat'] . ',' . $data['lon'];
  $form['locations'][0]['locpick']['current']['current_latitude']['#markup'] = $data['lat'];
  $form['locations'][0]['locpick']['current']['current_longitude']['#markup'] = $data['lon'];

  // Change clicked button text.
  $form['locations'][0]['submit']['#value'] = t('Reset marker');

  // Class hack to handle JS.
  $form['locations'][0]['#attributes']['class'] = array(
    'location',
    'js-show-map',
  );

  return $form['locations'];
}

/**
 * Ajax callback that resets the map marker and lat/lon.
 */
function ulf_maps_reset_coordinates($form, &$form_state) {
  // Update the values in the form.
  $form['locations'][0]['locpick']['user_latitude']['#value'] = '';
  $form['locations'][0]['locpick']['user_longitude']['#value'] = '';

  // Update default values with the new values.
  $form['locations'][0]['#default_value']['latitude'] = '';
  $form['locations'][0]['#default_value']['longitude'] = '';
  $form_state['values']['locations'][0]['locpick']['user_latitude'] = '';
  $form_state['values']['locations'][0]['locpick']['user_longitude'] = '';

  // Update map information with new location.
  $form['locations'][0]['locpick']['map']['#gmap_settings']['latitude'] = '';
  $form['locations'][0]['locpick']['map']['#gmap_settings']['longitude'] = '';
  $form['locations'][0]['locpick']['map']['#gmap_settings']['latlong'] = '' . ',' . '';
  $form['locations'][0]['locpick']['current']['current_latitude']['#markup'] = '';
  $form['locations'][0]['locpick']['current']['current_longitude']['#markup'] = '';

  // Change clicked button text.
  $form['locations'][0]['submit']['#value'] = t('Specify entrance on map');

  // Class hack to handle JS.
  $form['locations'][0]['#attributes']['class'] = array(
    'location',
    'js-enable-address',
  );

  return $form['locations'];
}