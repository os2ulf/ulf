/**
 * @name Search node Angular library
 * @version v1.0.3
 * @link https://github.com/search-node/searchpt
 */
angular.module("searchBoxApp",["communicationService","searchAppConfig","angular-cache"]),angular.module("searchResultApp",["communicationService","searchAppConfig","ngSanitize"]),angular.element(document).ready(function(){"use strict";var e=document.getElementById("searchResultApp");e&&angular.bootstrap(e,["searchResultApp"]);var r=document.getElementById("searchBoxApp");r&&angular.bootstrap(r,["searchBoxApp"])}),angular.module("searchBoxApp").controller("boxController",["CONFIG","communicatorService","searchProxy","$scope",function(e,r,t,n){"use strict";function a(){t.search(n.query).then(function(e){t.getFilters().then(function(e){n.filters=e},function(e){console.error(e)}),r.$emit("hits",{hits:e})},function(e){console.error(e)})}function o(){var r=t.init();n.filters=r.filters,n.template=e.templates.box,n.query={text:"",filters:{}},e.provider.hasOwnProperty("intervals")&&(n.intervals=e.provider.intervals,n.query.intervals={}),r.hasOwnProperty("query")?(n.query=r.query,a()):(e.provider.hasOwnProperty("pager")&&(n.query.pager=angular.copy(e.provider.pager)),n.filters=t.getFilters().then(function(e){n.filters=e},function(e){console.error(e)}))}r.$on("pager",function(e,r){n.query.pager={size:r.size,page:r.page},a()}),n.searchClicked=function(){n.query.hasOwnProperty("pager")&&(n.query.pager=angular.copy(e.provider.pager)),a()},o()}]),angular.module("searchResultApp").controller("resultController",["CONFIG","communicatorService","$scope",function(e,r,t){"use strict";t.template=e.templates.result,e.provider.hasOwnProperty("pager")&&(t.pager=angular.copy(e.provider.pager)),t.search=function(){r.$emit("pager",t.pager)},t.hits=[],r.$on("hits",function(e,r){t.$apply(function(){t.hits=r.hits})}),r.$on("pager",function(e,r){t.$apply(function(){t.pager=r})})}]),angular.module("searchBoxApp").directive("keyCode",function(){"use strict";return{restrict:"A",link:function(e,r,t){r.bind("keypress",function(r){var n=r.which||r.keyCode;n===Number(t.code)&&e.$apply(function(){e.$eval(t.keyCode,{$event:r})})})}}}),angular.module("searchResultApp").directive("searchPager",["CONFIG",function(e){"use strict";return{restrict:"E",replace:!0,scope:!0,controller:["$scope",function(e){e.changePage=function(r){e.pager.page=r,e.search()},e.prevPage=function(){e.pager.page>0&&(e.pager.page--,e.search())},e.nextPage=function(){e.pager.page<e.pager.max-1&&(e.pager.page++,e.search())},e.$watch("hits",function(r){var r=e.hits.hits,t=[];if(e.pager.max=0,r>e.pager.size){e.pager.max=Math.ceil(r/e.pager.size);for(var n=0;n<e.pager.max;n++)t.push(n)}e.pager.pages=t})}],templateUrl:e.templates.pager}}]),angular.module("searchBoxApp").service("jsonProvider",["CONFIG","$q","$http",function(e,r,t){"use strict";var n=[];t.get(e.provider.data).then(function(e){n=e.data}),this.getFilters=function(){return{tags:{name:"Tags",type:"and",items:[{name:"Angular",value:"angular"},{name:"Developer",value:"developer"},{name:"Javascript",value:"javascript"},{name:"Chrome",value:"chrome"}]},levels:{name:"Levels (or)",type:"or",items:[{name:"First",value:1},{name:"Second",value:2},{name:"Third",value:3},{name:"Fourth",value:4}]}}},this.search=function a(a){var e=this,t=angular.copy(n),o=r.defer();return""!==a.text&&(t=JSON.search(n,'//*[contains(title, "'+a.text+'")]')),angular.forEach(a.filters,function(r,n){var a=e.getFilters(),o=!1;angular.forEach(r,function(e,r){e&&("or"===a?o===!1?o="//*["+n+'="'+r+'"]':o+="|//*["+n+'="'+r+'"]':t=JSON.search(t,"//*["+n+'="'+r+'"]'))}),"or"===a&&o&&(t=JSON.search(t,o))}),o.resolve({hits:t.length,results:t}),o.promise}}]),angular.module("searchBoxApp").service("searchNodeProvider",["CONFIG","$q","$http","CacheFactory",function(e,r,t,n){"use strict";function a(e){var r=0;for(var t in e)e.hasOwnProperty(t)&&r++;return r}function o(){var e=r.defer();if(v)e.resolve();else{var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){("loaded"===t.readyState||"complete"===t.readyState)&&(t.onreadystatechange=null,v=!0,e.resolve())}:t.onload=function(){v=!0,e.resolve()},t.src=f.host+"/socket.io/socket.io.js",document.getElementsByTagName("head")[0].appendChild(t)}return e.promise}function i(e){o().then(function(){u=io.connect(f.host,{query:"token="+h,"force new connection":!0,"max reconnection attempts":1/0}),u.on("error",function(r){console.error(r,"Search socket error."),e.reject(r)}),u.on("connect",function(){e.resolve("Connected to the server.")}),u.on("disconnect",function(e){})})}function s(){var e=r.defer();return void 0===u?null!==h?i(e):t.get(f.auth).success(function(r){h=r.token,i(e)}).error(function(r,t){console.error(r,"Authentication (search) to search node failed ("+t+")"),e.reject(t)}):e.resolve("Connected to the server."),e.promise}function c(e){for(var r={aggs:{}},t=0;t<e.length;t++){var n=e[t];r.aggs[n.name]={terms:{field:n.field}}}return r}function l(r){var t={};if(e.provider.hasOwnProperty("filters"))for(var n=e.provider.filters,o=0;o<n.length;o++){var i=angular.copy(n[o]);if(t[i.field]={name:i.name,items:i.terms},0!==a(r))for(var s=0;s<r[i.name].buckets.length;s++){var c=r[i.name].buckets[s];t[i.field].items[c.key].count=Number(c.doc_count)}}return t}var u,p,f=e.provider,v=!1,h=null,g=new n("searchCache"+e.id,{maxAge:1e3*f.cacheExpire,deleteOnExpire:"aggressive",storageMode:"localStorage"});this.getRawFilters=function(){var r={};if(e.provider.hasOwnProperty("filters"))for(var t=e.provider.filters,n=0;n<t.length;n++)r[t[n].field]={name:t[n].name,items:t[n].terms};return r},this.getFilters=function(){var t=r.defer();if(e.provider.hasOwnProperty("filters")){var n=e.provider.filters;if(void 0===p){var a=g.get("filters");if(void 0!==a)p=a,t.resolve(angular.copy(p));else{var o=c(n);s().then(function(){u.emit("count",o),u.once("counts",function(e){var r=l(e);g.put("filters",r),p=r,t.resolve(r)}),u.once("searchError",function(e){console.error("Search error",e.message),t.reject(e.message)})})}}else t.resolve(angular.copy(p))}else t.resolve({});return t.promise},this.search=function(t){var n=r.defer(),a={index:f.index,query:{filtered:{query:{match_all:{}}}}};if(void 0!==t.text&&""!==t.text&&(a.query.filtered.query={multi_match:{query:t.text,fields:f.fields,analyzer:"string_search"}}),t.hasOwnProperty("filters")){var o=angular.copy(t.filters),i={bool:{must:[]}};for(var v in o){var h={execution:"and"};h[v]=[];for(var d in o[v])o[v][d]&&h[v].push(d);h[v].length&&i.bool.must.push({terms:angular.copy(h)})}i.bool.must.length&&(a.query.filtered.filter=i)}if(t.hasOwnProperty("pager")&&(a.size=t.pager.size,a.from=t.pager.page*t.pager.size),e.provider.hasOwnProperty("filters")){var m=c(e.provider.filters);angular.extend(a,m)}if(t.hasOwnProperty("intervals")){a.query.filtered.hasOwnProperty("filter")||(a.query.filtered.filter={bool:{must:[]}});for(var v in t.intervals){var y={range:{}};y.range[v]={gte:t.intervals[v].from,lte:t.intervals[v].to},a.query.filtered.filter.bool.must.push(y)}}var w=CryptoJS.MD5(JSON.stringify(a)).toString(),O=g.get(w);return void 0!==O?(O.hasOwnProperty("aggs")&&(p=l(angular.copy(O.aggs))),n.resolve(O)):s().then(function(){u.emit("search",a),u.once("result",function(e){e.hasOwnProperty("aggs")&&(p=l(angular.copy(e.aggs))),g.put(w,e),n.resolve(e)}),u.once("searchError",function(e){console.error("Search error",e.message),n.reject(e.message)})}),n.promise}}]),angular.module("communicationService",[]).service("communicatorService",["$rootScope","$window",function(e,r){"use strict";r.rootScopes=r.rootScopes||[],r.rootScopes.push(e),this.$emit=function(e,t){angular.forEach(r.rootScopes,function(r){r.$emit(e,t)})},this.$on=function(r,t){e.$on(r,function(r,n){t.apply(e,[r,n])})}}]),angular.module("searchBoxApp").service("searchProxy",["CONFIG","communicatorService","$injector",function(e,r,t){"use strict";function n(e){var r=0;for(var t in e)e.hasOwnProperty(t)&&r++;return r}function a(e){var r=[];if(e.hasOwnProperty("text")&&0!==e.text.length&&r.push("text="+encodeURIComponent(e.text)),e.hasOwnProperty("filters")&&0!==n(e.filters)){var t=[];for(var a in e.filters){var o=[];for(var i in e.filters[a])e.filters[a][i]===!0&&o.push(i);o.length&&t.push(a+":"+o.join(";"))}t.length&&r.push("filters="+encodeURIComponent(t.join("?")))}if(e.hasOwnProperty("intervals")&&0!==n(e.intervals)){var s=[];for(var a in e.intervals){var c=e.intervals[a];s.push(a+";"+c.from+";"+c.to)}r.push("intervals="+encodeURIComponent(s.join("?")))}return e.hasOwnProperty("pager")&&r.push("pager="+e.pager.page+":"+e.pager.size),r.join("&")}function o(e){var r={},t=e.substr(2).split("&");for(var n in t){var a=t[n].split("=");switch(a[0]){case"text":r.text=decodeURIComponent(a[1]);break;case"filters":var o=decodeURIComponent(a[1]).split("?");if(o.length){r.filters={};for(var i in o){var s=o[i].split(":");r.filters[s[0]]=s[1].split(";").reduce(function(e,r,t){return e[r]=!0,e},{})}}break;case"intervals":var c=decodeURIComponent(a[1]).split("?");if(c.length){r.intervals={};for(var i in c){var l=c[i].split(";");r.intervals[l[0]]={from:l[1],to:l[2]}}}break;case"pager":var u=a[1].split(":");r.pager={page:Number(u[0]),size:Number(u[1])};break;default:console.error("Decoding of search hash has unknown parts - "+a[0])}}return r}var i=t.get(e.provider.service);this.init=function(){var e={filters:this.getRawFilters()},r=window.location.hash;return r.length>2&&(e.query=o(r)),e},this.search=function(r){var t=angular.copy(r);if(e.provider.hasOwnProperty("intervals")&&e.provider.intervals.length){if(t.hasOwnProperty("intervals"))for(var n in t.intervals)t.intervals[n].hasOwnProperty("from")&&""!==t.intervals[n].from&&t.intervals[n].hasOwnProperty("to")&&""!==t.intervals[n].to||delete t.intervals[n]}else t.hasOwnProperty("intervals")&&delete t.intervals;if(window.location.hash=a(t),e.provider.hasOwnProperty("force")&&e.provider.force.length){t.hasOwnProperty("filters")||(t.filters={});var o=e.provider.force;for(var s in o){var c=o[s];t.filters.hasOwnProperty(c.field)||(t.filters[c.field]={});for(var l in c.values)t.filters[c.field][c.values[l]]=!0}}return i.search(t)},this.getRawFilters=function(){return i.getRawFilters()},this.getFilters=function(){return i.getFilters()}}]);
//# sourceMappingURL=/maps/search.js.map