/**
 * @name Search node Angular library
 * @version v1.0.0-rc2
 * @link https://github.com/search-node/searchpt
 */
angular.module("searchBoxApp",["communicationService","searchAppConfig","angular-cache"]),angular.module("searchResultApp",["communicationService","searchAppConfig"]),angular.element(document).ready(function(){"use strict";var e=document.getElementById("searchResultApp");e&&angular.bootstrap(e,["searchResultApp"]);var r=document.getElementById("searchBoxApp");r&&angular.bootstrap(r,["searchBoxApp"])}),angular.module("searchBoxApp").controller("boxController",["CONFIG","communicatorService","searchProxy","$scope",function(e,r,t,o){"use strict";function n(){t.search(o.query).then(function(e){t.getFilters().then(function(e){o.filters=e},function(e){console.error(e)}),r.$emit("hits",{hits:e})},function(e){console.error(e)})}o.template=e.templates.box,o.query={text:"",filters:{}},e.provider.hasOwnProperty("pager")&&(o.query.pager=angular.copy(e.provider.pager)),t.getFilters().then(function(e){o.filters=e},function(e){console.error(e)}),r.$on("pager",function(e,r){o.query.pager={size:r.size,page:r.page},n()}),o.searchClicked=function(){o.query.hasOwnProperty("pager")&&(o.query.pager=angular.copy(e.provider.pager)),n()}}]),angular.module("searchResultApp").controller("resultController",["CONFIG","communicatorService","$scope",function(e,r,t){"use strict";t.template=e.templates.result,e.provider.hasOwnProperty("pager")&&(t.pager=angular.copy(e.provider.pager)),t.search=function(){r.$emit("pager",t.pager)},t.hits=[],r.$on("hits",function(e,r){t.$apply(function(){t.hits=r.hits})}),r.$on("pager",function(e,r){t.$apply(function(){t.pager=r})})}]),angular.module("searchBoxApp").directive("keyCode",function(){"use strict";return{restrict:"A",link:function(e,r,t){r.bind("keypress",function(r){var o=r.which||r.keyCode;o===t.code&&e.$apply(function(){e.$eval(t.keyCode,{$event:r})})})}}}),angular.module("searchResultApp").directive("searchPager",[function(){"use strict";return{restrict:"E",replace:!0,scope:!0,controller:["$scope",function(e){e.changePage=function(r){e.pager.page=r,e.search()},e.prevPage=function(){e.pager.page>0&&(e.pager.page--,e.search())},e.nextPage=function(){e.pager.page<e.pager.max-1&&(e.pager.page++,e.search())},e.$watch("hits",function(r){var r=e.hits.hits,t=[];if(e.pager.max=0,r>e.pager.size){e.pager.max=Math.ceil(r/e.pager.size);for(var o=0;o<e.pager.max;o++)t.push(o)}e.pager.pages=t})}],templateUrl:"/js/directive/pager-directive.html"}}]),angular.module("searchBoxApp").service("jsonProvider",["CONFIG","$q","$http",function(e,r,t){"use strict";var o=[];t.get(e.provider.data).then(function(e){o=e.data}),this.getFilters=function(){return{tags:{name:"Tags",type:"and",items:[{name:"Angular",value:"angular"},{name:"Developer",value:"developer"},{name:"Javascript",value:"javascript"},{name:"Chrome",value:"chrome"}]},levels:{name:"Levels (or)",type:"or",items:[{name:"First",value:1},{name:"Second",value:2},{name:"Third",value:3},{name:"Fourth",value:4}]}}},this.search=function n(n){var e=this,t=angular.copy(o),a=r.defer();return""!==n.text&&(t=JSON.search(o,'//*[contains(title, "'+n.text+'")]')),angular.forEach(n.filters,function(r,o){var n=e.getFilters(),a=!1;angular.forEach(r,function(e,r){e&&("or"===n?a===!1?a="//*["+o+'="'+r+'"]':a+="|//*["+o+'="'+r+'"]':t=JSON.search(t,"//*["+o+'="'+r+'"]'))}),"or"===n&&a&&(t=JSON.search(t,a))}),a.resolve({hits:t.length,results:t}),a.promise}}]),angular.module("searchBoxApp").service("searchNodeProvider",["CONFIG","$q","$http","CacheFactory",function(e,r,t,o){"use strict";function n(){var e=r.defer();if(g)e.resolve();else{var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){("loaded"===t.readyState||"complete"===t.readyState)&&(t.onreadystatechange=null,g=!0,e.resolve())}:t.onload=function(){g=!0,e.resolve()},t.src=p.host+"/socket.io/socket.io.js",document.getElementsByTagName("head")[0].appendChild(t)}return e.promise}function a(e){n().then(function(){u=io.connect(p.host,{query:"token="+h,"force new connection":!0,"max reconnection attempts":1/0}),u.on("error",function(r){console.error(r,"Search socket error."),e.reject(r)}),u.on("connect",function(){e.resolve("Connected to the server.")}),u.on("disconnect",function(e){})})}function c(){var e=r.defer();return void 0===u?null!==h?a(e):t.get(p.auth).success(function(r){h=r.token,a(e)}).error(function(r,t){console.error(r,"Authentication (search) to search node failed ("+t+")"),e.reject(t)}):e.resolve("Connected to the server."),e.promise}function i(e){for(var r={aggs:{}},t=0;t<e.length;t++){var o=e[t];r.aggs[o.name]={terms:{field:o.field}}}return r}function s(r){for(var t={},o=e.provider.filters,n=0;n<o.length;n++){var a=angular.copy(o[n]);t[a.field]={name:a.name,items:a.terms};for(var c=0;c<r[a.name].buckets.length;c++){var i=r[a.name].buckets[c];t[a.field].items[i.key].count=Number(i.doc_count)}}return t}var u,l,p=e.provider,g=!1,h=null,f=new o("searchCache",{maxAge:1e3*p.cacheExpire,deleteOnExpire:"passive",storageMode:"localStorage"});this.getFilters=function(){var t=r.defer();if(e.provider.hasOwnProperty("filters")){var o=e.provider.filters;if(void 0===l){var n=f.get("filters");if(void 0!==n)l=n,t.resolve(angular.copy(l));else{var a=i(o);c().then(function(){u.emit("count",a),u.once("counts",function(e){var r=s(e);f.put("filters",r),l=r,t.resolve(r)}),u.once("searchError",function(e){console.error("Search error",e.message),t.reject(e.message)})})}}else t.resolve(angular.copy(l))}else t.resolve({});return t.promise},this.search=function(t){var o=r.defer(),n={index:p.index,query:{filtered:{query:{match_all:{}}}}};if(void 0!==t.text&&""!==t.text&&(n.query.filtered.query={multi_match:{query:t.text,fields:p.fields,analyzer:"string_search"}}),t.hasOwnProperty("filters")){var a=angular.copy(t.filters),g={bool:{must:[]}};for(var h in a){var v={execution:"and"};v[h]=[];for(var m in a[h])a[h][m]&&v[h].push(m);v[h].length&&g.bool.must.push({terms:angular.copy(v)})}g.bool.must.length&&(n.query.filtered.filter=g)}if(t.hasOwnProperty("pager")&&(n.size=t.pager.size,n.from=t.pager.page*t.pager.size),e.provider.hasOwnProperty("filters")){var d=i(e.provider.filters);angular.extend(n,d)}var y=CryptoJS.MD5(JSON.stringify(n)).toString(),x=f.get(y);return void 0!==x?(x.hasOwnProperty("aggs")&&(l=s(angular.copy(x.aggs))),o.resolve(x)):c().then(function(){u.emit("search",n),u.once("result",function(e){e.hasOwnProperty("aggs")&&(l=s(angular.copy(e.aggs))),f.put(y,e),o.resolve(e)}),u.once("searchError",function(e){console.error("Search error",e.message),o.reject(e.message)})}),o.promise}}]),angular.module("communicationService",[]).service("communicatorService",["$rootScope","$window",function(e,r){"use strict";r.rootScopes=r.rootScopes||[],r.rootScopes.push(e),this.$emit=function(e,t){angular.forEach(r.rootScopes,function(r){r.$emit(e,t)})},this.$on=function(r,t){e.$on(r,function(r,o){t.apply(e,[r,o])})}}]),angular.module("searchBoxApp").service("searchProxy",["CONFIG","communicatorService","$injector",function(e,r,t){"use strict";var o=t.get(e.provider.service);this.search=function(e){return o.search(e)},this.getFilters=function(){return o.getFilters()}}]);
//# sourceMappingURL=/maps/search.js.map